@model TourManagementApi.Models.Activity

@{
    ViewData["Title"] = "Create Activity";
}

<div class="container">
    <h2>Create Activity</h2>
    
    <!-- Progress bar -->
    <div class="progress mb-4">
        <div class="progress-bar" role="progressbar" style="width: 16.66%;" 
             aria-valuenow="16.66" aria-valuemin="0" aria-valuemax="100">Step 1 of 6</div>
    </div>

    <!-- Steps indicator -->
    <div class="steps-indicator mb-4">
        <div class="step active" data-step="1">Basic Information</div>
        <div class="step" data-step="2">Location & Contact</div>
        <div class="step" data-step="3">Pricing</div>
        <div class="step" data-step="4">Time Management</div>
        <div class="step" data-step="5">Meeting Points</div>
        <div class="step" data-step="6">Language & Preview</div>
    </div>

    <form id="createForm" class="mt-4">
        <!-- Step 1: Basic Information -->
        <div class="form-step" id="step1" style="display: block;">
            <h4>Basic Information</h4>
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
                <div class="invalid-feedback">Please enter a title.</div>
            </div>

            <div class="form-group">
                <label for="category">Category</label>
                <select class="form-control" id="category" name="category" required onchange="updateSubcategories()">
                    <option value="">Select a category</option>
                    <option value="Adventure">Adventure</option>
                    <option value="Cultural">Cultural</option>
                    <option value="Nature">Nature</option>
                    <option value="Sports">Sports</option>
                    <option value="Food">Food & Drink</option>
                    <option value="Wellness">Wellness</option>
                </select>
                <div class="invalid-feedback">Please select a category.</div>
            </div>

            <div class="form-group">
                <label for="subcategory">Subcategory</label>
                <select class="form-control" id="subcategory" name="subcategory" required>
                    <option value="">First select a category</option>
                </select>
                <div class="invalid-feedback">Please select a subcategory.</div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                <div class="invalid-feedback">Please enter a description.</div>
            </div>

            <!-- Languages -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Available Languages</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <div id="languages">
                            <div class="input-group mb-2">
                                <select class="form-control language-select" name="languages[]" required>
                                    <option value="">Select a language</option>
                                    <option value="tr">Türkçe</option>
                                    <option value="en">English</option>
                                    <option value="de">Deutsch</option>
                                    <option value="fr">Français</option>
                                    <option value="es">Español</option>
                                    <option value="it">Italiano</option>
                                    <option value="ru">Русский</option>
                                    <option value="ar">العربية</option>
                                </select>
                                <button type="button" class="btn btn-danger remove-language">Remove</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary mt-2" onclick="addLanguage()">Add Language</button>
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <h5 class="mt-4">Contact Information</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contactName">Contact Name</label>
                        <input type="text" class="form-control" id="contactName" name="contactInfo.name" required>
                        <div class="invalid-feedback">Please enter a contact name.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contactRole">Role</label>
                        <select class="form-control" id="contactRole" name="contactInfo.role" required>
                            <option value="">Select a role</option>
                            <option value="guide">Guide</option>
                            <option value="tourOperator">Tour Operator</option>
                            <option value="manager">Manager</option>
                            <option value="coordinator">Tour Coordinator</option>
                            <option value="assistant">Tour Assistant</option>
                        </select>
                        <div class="invalid-feedback">Please select a role.</div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contactEmail">Email</label>
                        <input type="email" class="form-control" id="contactEmail" name="contactInfo.email" required>
                        <div class="invalid-feedback">Please enter a valid email address.</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="contactPhone">Phone</label>
                        <input type="tel" class="form-control" id="contactPhone" name="contactInfo.phone" required>
                        <div class="invalid-feedback">Please enter a valid phone number (minimum 10 digits).</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Location & Contact -->
        <div class="form-step" id="step2" style="display: none;">
            <h4>Location</h4>
            
            <!-- Location -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Activity Location</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="locationSearch">Search Address</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="locationSearch" placeholder="Enter address to search...">
                            <button type="button" class="btn btn-primary" onclick="searchLocation()">Search</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div id="locationMap" style="height: 300px;" class="mb-3"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <input type="text" class="form-control" id="address" name="location.address" required>
                                <div class="invalid-feedback">Please enter an address.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" class="form-control" id="city" name="location.city" required>
                                <div class="invalid-feedback">Please enter a city.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="country">Country</label>
                                <input type="text" class="form-control" id="country" name="location.country" required>
                                <div class="invalid-feedback">Please enter a country.</div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="latitude" name="location.latitude">
                    <input type="hidden" id="longitude" name="location.longitude">
                </div>
            </div>
        </div>

        <!-- Step 3: Pricing -->
        <div class="form-step" id="step3" style="display: none;">
            <h4>Pricing Information</h4>
            
            <!-- Genel Fiyatlandırma Ayarları -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Genel Fiyatlandırma Ayarları</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="defaultCurrency">Varsayılan Para Birimi</label>
                                <select class="form-select" id="defaultCurrency" name="pricing.defaultCurrency" required>
                                    <option value="">Para birimi seçin</option>
                                    <option value="TRY">TRY - Türk Lirası</option>
                                    <option value="USD">USD - Amerikan Doları</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - İngiliz Sterlini</option>
                                </select>
                                <div class="invalid-feedback">Lütfen para birimi seçin.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="taxRate">KDV Oranı (%)</label>
                                <input type="number" class="form-control" id="taxRate" name="pricing.taxRate" min="0" max="100" step="0.01" required>
                                <div class="invalid-feedback">Lütfen geçerli bir KDV oranı girin.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fiyat Kategorileri -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Fiyat Kategorileri</h5>
                </div>
                <div class="card-body">
                    <div id="priceCategories">
                        <!-- Default price category -->
                        <div class="price-category border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Kategori Tipi</label>
                                        <select class="form-select category-type" name="priceCategories[0].type" required>
                                            <option value="">Kategori seçin</option>
                                            <option value="Adult">Adult</option>
                                            <option value="Child">Child</option>
                                            <option value="Infant">Infant</option>
                                            <option value="Senior">Senior</option>
                                            <option value="Youth">Youth</option>
                                            <option value="Student">Student</option>
                                            <option value="Military">Military</option>
                                            <option value="Group">Group</option>
                                            <option value="Traveller">Traveller</option>
                                            <option value="Family">Family</option>
                                            <option value="Transfer">Transfer</option>
                                            <option value="Room">Room</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Fiyat Tipi</label>
                                        <select class="form-select price-type" name="priceCategories[0].priceType" required>
                                            <option value="">Fiyat tipi seçin</option>
                                            <option value="Fixed">Sabit</option>
                                            <option value="Variable">Değişken</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Tutar</label>
                                        <input type="number" class="form-control amount" name="priceCategories[0].amount" min="0" step="0.01" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="form-group">
                                        <label>Açıklama</label>
                                        <textarea class="form-control description" name="priceCategories[0].description" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end mt-2">
                                <button type="button" class="btn btn-danger btn-sm remove-category" onclick="removePriceCategory(this)">
                                    <i class="fas fa-trash"></i> Kategoriyi Sil
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addPriceCategory()">
                        <i class="fas fa-plus"></i> Yeni Fiyat Kategorisi Ekle
                    </button>
                </div>
            </div>

            <!-- Services & Requirements -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Services & Requirements</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group" id="includedServices">
                                <label>Included Services:</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="included[]" />
                                    <button type="button" class="btn btn-outline-secondary add-field" data-target="includedServices">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group" id="excludedServices">
                                <label>Excluded Services:</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" name="excluded[]" />
                                    <button type="button" class="btn btn-outline-secondary add-field" data-target="excludedServices">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="requirements">
                        <label>Requirements:</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" name="requirements[]" />
                            <button type="button" class="btn btn-outline-secondary add-field" data-target="requirements">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Additional Information</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="cancellationPolicy">Cancellation Policy:</label>
                        <textarea class="form-control" id="cancellationPolicy" name="cancellationPolicy" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="additionalNotes">Additional Notes:</label>
                        <textarea class="form-control" id="additionalNotes" name="additionalNotes" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Time Management -->
        <div class="form-step" id="step4" style="display: none;">
            <h4>Time Management</h4>
            
            <!-- Duration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Duration</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="duration">Süre (dakika)</label>
                        <input type="number" class="form-control" id="duration" name="duration" required min="1">
                        <div class="invalid-feedback">Lütfen geçerli bir süre girin.</div>
                    </div>
                </div>
            </div>
            
            <!-- Seasonal Availability -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Sezon Bilgileri</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="seasonStartDate">Sezon Başlangıç Tarihi</label>
                                <input type="date" class="form-control" id="seasonStartDate" name="seasonalAvailability.startDate" required>
                                <div class="invalid-feedback">Lütfen başlangıç tarihi seçin.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="seasonEndDate">Sezon Bitiş Tarihi</label>
                                <input type="date" class="form-control" id="seasonEndDate" name="seasonalAvailability.endDate" required>
                                <div class="invalid-feedback">Lütfen bitiş tarihi seçin.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Slots -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Zaman Dilimleri</h5>
                    <button type="button" class="btn btn-primary" onclick="addTimeSlot()">
                        <i class="fas fa-plus"></i> Zaman Dilimi Ekle
                    </button>
                </div>
                <div class="card-body">
                    <div id="timeSlotsContainer">
                        <!-- Time slots will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Meeting Points -->
        <div class="form-step" id="step5" style="display: none;">
            <h4>Buluşma Noktaları</h4>
            
            <!-- Meeting Points List -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Buluşma Noktaları</h5>
                    <button type="button" class="btn btn-primary" onclick="showMeetingPointForm()">
                        <i class="fas fa-plus"></i> Buluşma Noktası Ekle
                    </button>
                </div>
                <div class="card-body">
                    <div id="meetingPointsContainer">
                        <!-- Meeting points will be added here -->
                    </div>
                </div>
            </div>

            <!-- Meeting Point Form Modal -->
            <div class="modal fade" id="meetingPointModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Buluşma Noktası Ekle</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Map -->
                            <div class="form-group mb-3">
                                <label for="meetingPointSearch">Adres Ara</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="meetingPointSearch" placeholder="Aramak istediğiniz adresi girin...">
                                    <button type="button" class="btn btn-primary" onclick="searchMeetingPoint()">Ara</button>
                                </div>
                            </div>
                            <div id="meetingPointMap" style="height: 400px;" class="mb-3"></div>

                            <!-- Form Fields -->
                            <div class="form-group mb-3">
                                <label for="meetingPointName">Buluşma Noktası Adı</label>
                                <input type="text" class="form-control" id="meetingPointName" required>
                            </div>
                            <div class="form-group mb-3">
                                <label for="meetingPointAddress">Adres</label>
                                <input type="text" class="form-control" id="meetingPointAddress" required>
                            </div>
                            <input type="hidden" id="meetingPointLat">
                            <input type="hidden" id="meetingPointLng">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                            <button type="button" class="btn btn-primary" onclick="saveMeetingPoint()">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 6: Language & Preview -->
        <div class="form-step" id="step6" style="display: none;">
            <h4>Preview</h4>
            
            <!-- Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Activity Status</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select class="form-control" id="status" name="status" required>
                            <option value="draft">Draft</option>
                            <option value="published">Published</option>
                            <option value="inactive">Inactive</option>
                        </select>
                        <div class="invalid-feedback">Please select a status.</div>
                        <small class="form-text text-muted">
                            Draft: Save as draft to edit later<br>
                            Published: Make the activity visible to customers<br>
                            Inactive: Temporarily hide the activity
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Preview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Activity Preview</h5>
                </div>
                <div class="card-body">
                    <div class="preview-section">
                        <h5>Basic Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Title:</strong> <span id="preview-title"></span></p>
                                <p><strong>Category:</strong> <span id="preview-category"></span></p>
                                <p><strong>Duration:</strong> <span id="preview-duration"></span> hours</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Status:</strong> <span id="preview-status"></span></p>
                                <p><strong>Languages:</strong> <span id="preview-languages"></span></p>
                            </div>
                        </div>
                        <p><strong>Description:</strong></p>
                        <p id="preview-description"></p>
                    </div>

                    <div class="preview-section mt-4">
                        <h5>Location & Contact</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Address:</strong> <span id="preview-address"></span></p>
                                <p><strong>City:</strong> <span id="preview-city"></span></p>
                                <p><strong>Country:</strong> <span id="preview-country"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Contact Name:</strong> <span id="preview-contact-name"></span></p>
                                <p><strong>Contact Email:</strong> <span id="preview-contact-email"></span></p>
                                <p><strong>Contact Phone:</strong> <span id="preview-contact-phone"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="preview-section mt-4">
                        <h5>Pricing</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Base Price:</strong> <span id="preview-base-price"></span></p>
                                <p><strong>Currency:</strong> <span id="preview-currency"></span></p>
                                <p><strong>Tax Rate:</strong> <span id="preview-tax-rate"></span>%</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Min Participants:</strong> <span id="preview-min-participants"></span></p>
                                <p><strong>Max Participants:</strong> <span id="preview-max-participants"></span></p>
                                <p><strong>Tax Included:</strong> <span id="preview-tax-included"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="preview-section mt-4">
                        <h5>Time Slots</h5>
                        <p id="preview-time-slots"></p>
                    </div>

                    <div class="preview-section mt-4">
                        <h5>Services & Requirements</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Included Services:</strong></p>
                                <p id="preview-included-services"></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Excluded Services:</strong></p>
                                <p id="preview-excluded-services"></p>
                            </div>
                        </div>
                        <p><strong>Requirements:</strong></p>
                        <p id="preview-requirements"></p>
                    </div>

                    <div class="preview-section mt-4">
                        <h5>Additional Information</h5>
                        <p><strong>Cancellation Policy:</strong></p>
                        <p id="preview-cancellation-policy"></p>
                        <p><strong>Additional Notes:</strong></p>
                        <p id="preview-additional-notes"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation buttons -->
        <div class="form-navigation mt-4">
            <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Previous</button>
            <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">Create Activity</button>
            <a asp-action="Index" class="btn btn-link">Back to List</a>
        </div>
    </form>
</div>

@section Styles {
    <style>
        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-bottom: 3px solid #ddd;
            color: #666;
        }

        .step.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
        }

        .form-navigation {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
    </style>
}

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const defaultLocation = {
            lat: 41.0082,
            lng: 28.9784
        };
    </script>
    <script src="~/js/activity-form.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize step navigation
            initStepNavigation();
            
            // Initialize maps when steps are shown
            document.getElementById('step2Link').addEventListener('click', function() {
                setTimeout(initLocationMap, 100);
            });
            
            document.getElementById('step5Link').addEventListener('click', function() {
                setTimeout(initMeetingPointMap, 100);
            });
            
            // Initialize first step's map
            if (document.getElementById('step2').style.display !== 'none') {
                setTimeout(initLocationMap, 100);
            }
        });
    </script>
}