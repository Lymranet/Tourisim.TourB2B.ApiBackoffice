@model TourManagementApi.Models.ViewModels.BookingDetailVM
@{
    ViewData["Title"] = $"Rezervasyon Detayı - {Model.Header.OrderNumber}";
    Func<string, string> badge = s => s switch
    {
        "CONFIRMED" => "badge bg-success",
        "CANCELLED" => "badge bg-danger",
        "PROCESSING" => "badge bg-warning text-dark",
        _ => "badge bg-info"
    };
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Rezervasyon: @Model.Header.OrderNumber</h3>
    <div>
        <a asp-action="Index" class="btn btn-secondary me-2">← Liste</a>

        @*<form asp-action="Delete" method="post" class="d-inline"
              onsubmit="return confirm('Bu rezervasyonu ve tüm alt detaylarını silmek istediğinizden emin misiniz?');">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Header.BookingId" />
            <button type="submit" class="btn btn-danger">Sil</button>
        </form>*@
    </div>
</div>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                Özet
            </div>
            <div class="card-body">
                <div><strong>Kod:</strong> @Model.Header.Code</div>
                <div><strong>Durum:</strong> <span class="@badge(Model.Header.Status)">@Model.Header.Status</span></div>
                <div><strong>Oluşturma:</strong> @Model.Header.DateCreated?.ToString("dd.MM.yyyy HH:mm")</div>
                <div><strong>Onay:</strong> @Model.Header.DateConfirmed?.ToString("dd.MM.yyyy HH:mm")</div>
                <div class="mt-2"><strong>Tutar:</strong> @($"{Model.Header.TotalAmount:N2} {Model.Header.TotalCurrency}")</div>
                <div><strong>Ödendi:</strong> @Model.Header.TotalPaid.ToString("N2")</div>
                <div><strong>Kalan:</strong> @Model.Header.TotalDue.ToString("N2")</div>

                @* Booking-level barcode (Fields -> "Barcode") yoksa barcode=OrderNumber varsayılır *@
                <hr />
                <div><strong>Barcode:</strong> @(string.IsNullOrWhiteSpace(Model.Header.BarcodeValue) ? Model.Header.OrderNumber : Model.Header.BarcodeValue)</div>
                <div><small class="text-muted">Tür: @(Model.Header.BarcodeType ?? "QR_CODE")</small></div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Müşteriler (@Model.Customers.Count)</div>
            <div class="card-body">
                @if (Model.Customers == null || !Model.Customers.Any())
                {
                    <div class="text-muted">Müşteri bilgisi yok.</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Email</th>
                                    <th>Telefon</th>
                                    <th>Ülke</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var c in Model.Customers)
                                {
                                    <tr>
                                        <td>@c.Name</td>
                                        <td>@c.Email</td>
                                        <td>@c.Phone</td>
                                        <td>@c.CountryCode</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

    </div>

    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">Kaynak / Tedarikçi</div>
            <div class="card-body">
                <div><strong>Kaynak:</strong> @Model.Source (@Model.SourceChannel)</div>
                <div><strong>Tedarikçi:</strong> @Model.SupplierName</div>
                <div><strong>Aracı:</strong> @Model.ResellerName</div>
                <hr />
                <div><strong>İç Notlar:</strong><br /> @Model.InternalNotes</div>
                <div class="mt-2"><strong>Aracı Notları:</strong><br /> @Model.ResellerComments</div>
            </div>
        </div>
    </div>
</div>

<h4 class="mt-4">Ürün / Oturum(lar)</h4>
@foreach (var it in Model.Items)
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
            <div>
                <strong>@it.ProductName</strong>
                @if (!string.IsNullOrEmpty(it.ActivityTitle))
                {<span class="text-muted"> — @it.ActivityTitle</span>}
            </div>
            <div>
                <span class="me-3"><strong>Başlangıç:</strong> @it.StartTimeLocal?.ToString("dd.MM.yyyy HH:mm")</span>
                @if (it.EndTimeLocal.HasValue)
                {<span><strong>Bitiş:</strong> @it.EndTimeLocal?.ToString("dd.MM.yyyy HH:mm")</span>}
            </div>
        </div>
        <div class="card-body">
            <div class="mb-2">
                <strong>Miktar Toplam:</strong> @it.QuantitySum
                <span class="text-muted ms-2">(Alt kırılım aşağıda)</span>
            </div>

            @if (it.Quantities.Any())
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>Fiyatlandırma</th><th>Adet</th><th>Birim Fiyat</th></tr></thead>
                        <tbody>
                            @foreach (var q in it.Quantities)
                            {
                                <tr>
                                    <td>@q.OptionLabel</td>
                                    <td>@q.Value</td>
                                    <td>@(q.OptionPrice.HasValue ? q.OptionPrice.Value.ToString("N2") : "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (it.Extras.Any())
            {
                <div class="mt-3">
                    <strong>Ekstralar</strong>
                    <ul class="mb-0">
                        @foreach (var ex in it.Extras)
                        {
                            <li>@ex.Name (x@ex.Quantity) — @ex.Price.ToString("N2")</li>
}
                    </ul>
                </div>
            }

            @if (it.Pickup is not null)
            {
                <div class="mt-3">
                    <strong>Alış Bilgisi:</strong>
                    <div>@it.Pickup.LocationName — @it.Pickup.Address</div>
                    <div><small>@it.Pickup.PickupInstructions</small></div>
                    <div><small>Saat: @it.Pickup.PickupTime</small></div>
                </div>
            }

            @if (it.Vouchers.Any())
            {
                <div class="mt-3">
                    <strong>Voucher(lar)</strong>
                    <ul class="mb-0">
                        @foreach (var v in it.Vouchers)
                        {
                            <li>@v.Code — @v.Status — @v.Value @v.ValueType</li>
}
                    </ul>
                </div>
            }

            @if (it.Participants.Any())
            {
                <div class="mt-3">
                    <strong>Katılımcılar</strong>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>#</th><th>Alan</th><th>Değer</th></tr></thead>
                            <tbody>
                                @for (int idx = 0; idx < it.Participants.Count; idx++)
                                {
                                    var p = it.Participants[idx];
                                    if (!p.Fields.Any())
                                    {
                                        <tr><td>@(idx+1)</td><td colspan="2" class="text-muted">Alan yok</td></tr>
                                    }
                                    else
                                    {
                                        foreach (var f in p.Fields)
                                        {
                                            <tr>
                                                <td>@(idx+1)</td>
                                                <td>@f.Label</td>
                                                <td>
                                                    @f.Value
                                                    @* Katılımcı özel Barcode alanı *@
                                                    @if (f.Label == "Barcode")
                                                    {
                                                        <span class="badge bg-light text-dark ms-2">@(f.BarcodeType ?? "QR_CODE")</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>

        <div class="card-footer d-flex gap-3">
            <div><strong>Satır Ara Toplam:</strong> @it.Subtotal.ToString("N2")</div>
            <div><strong>Vergi:</strong> @it.TotalItemTax.ToString("N2")</div>
            <div><strong>Toplam:</strong> @it.Amount.ToString("N2")</div>
        </div>
    </div>
}

@if (Model.Payments.Any())
{
    <h4>Ödemeler</h4>
    <div class="table-responsive">
        <table class="table table-sm">
            <thead><tr><th>Tarih</th><th>Tip</th><th>Tutar</th></tr></thead>
            <tbody>
                @foreach (var p in Model.Payments)
                {
                    <tr>
                        <td>@p.Date?.ToString("dd.MM.yyyy HH:mm")</td>
                        <td>@p.Type</td>
                        <td>@($"{p.Amount:N2} {p.Currency}")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
